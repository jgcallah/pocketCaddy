<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <title>PocketCaddy</title>
    <base href="/PocketCaddy/" />
    <link rel="stylesheet" href="lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/app.css" />
    <link rel="apple-touch-icon" href="img/icons/180.png" />
    <!-- For non-retina devices -->
    <link rel="apple-touch-icon" sizes="180x180" href="img/icons/180.png" />
    <!-- For iPad Pro -->
    <link rel="apple-touch-icon" sizes="167x167" href="img/icons/167.png" />
    <!-- For other iPads -->
    <link rel="apple-touch-icon" sizes="152x152" href="img/icons/152.png" />

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json" />

    <!-- Splash Screen Meta (iOS) -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />

    <link href="PocketCaddy.styles.css" rel="stylesheet" />
  </head>
  <script src="scripts.js"></script>
  <script>
    // Force iOS to save current state when app backgrounds
    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "hidden") {
        localStorage.setItem("lastSaved", Date.now());
      }
    });

    // Force iOS to update the app preview with current content
    function updateAppSnapshot() {
      // This tricks iOS into taking a fresh snapshot
      const dummy = document.createElement("div");
      dummy.style.visibility = "hidden";
      document.body.appendChild(dummy);
      setTimeout(() => {
        document.body.removeChild(dummy);
      }, 100);
    }

    // Update snapshot when app backgrounds
    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "hidden") {
        updateAppSnapshot();
      }
    });

    // Handle redirect after 404
    (function () {
      var redirect = sessionStorage.redirect;
      delete sessionStorage.redirect;
      if (redirect && redirect != location.href) {
        history.replaceState(null, null, redirect);
      }
    })();

    if ("serviceWorker" in navigator) {
      const basePath = "/pocketCaddy/"; // â† Match your repo name
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register(basePath + "service-worker.js", {
            scope: basePath,
          })
          .then((registration) => {
            console.log("SW registered: ", registration);
          })
          .catch((registrationError) => {
            console.log("SW registration failed: ", registrationError);
          });
      });
    }

    (function () {
      const basePath = "/PocketCaddy/";
      const absoluteUrl = (relativePath) => {
        if (relativePath.startsWith("/"))
          return basePath + relativePath.substring(1);
        return basePath + relativePath;
      };

      // Fix script paths dynamically
      document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll("script[src]").forEach((script) => {
          if (!script.src.startsWith("http")) {
            script.src = absoluteUrl(script.getAttribute("src"));
          }
        });
      });
    })();
  </script>
  <body>
    <div id="app">
      <svg class="loading-progress">
        <circle r="40%" cx="50%" cy="50%" />
        <circle r="40%" cx="50%" cy="50%" />
      </svg>
      <div class="loading-progress-text"></div>
    </div>

    <div id="blazor-error-ui">
      An unhandled error has occurred.
      <a href="." class="reload">Reload</a>
      <span class="dismiss">ðŸ—™</span>
    </div>
    <script src="_framework/blazor.webassembly.js"></script>
  </body>
</html>
